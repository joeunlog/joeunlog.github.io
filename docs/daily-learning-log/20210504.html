<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>2021-05-04 - Joeunlog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>2021-05-04 | Joeunlog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="2021-05-04" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <link rel="canonical" href="/docs/daily-learning-log/20210504.html" /> <meta property="og:url" content="/docs/daily-learning-log/20210504.html" /> <meta property="og:site_name" content="Joeunlog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="2021-05-04" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/docs/daily-learning-log/20210504.html","headline":"2021-05-04","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Joeunlog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/" class="nav-list-link">Joeunvit Study log</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/python-study/" class="nav-list-link">Python-study</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/python-study/01-set-environment.html" class="nav-list-link">Setting environment</a></li><li class="nav-list-item "><a href="/docs/python-study/02-data-type.html" class="nav-list-link">Data type</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/daily-learning-log/" class="nav-list-link">Daily-learning-log</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/daily-learning-log/20210127.html" class="nav-list-link">2021-01-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210128.html" class="nav-list-link">2021-01-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210129.html" class="nav-list-link">2021-01-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210201.html" class="nav-list-link">2021-02-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210205.html" class="nav-list-link">2021-02-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210329.html" class="nav-list-link">2021-03-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210330.html" class="nav-list-link">2021-03-30</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210331.html" class="nav-list-link">2021-03-31</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210401.html" class="nav-list-link">2021-04-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210405.html" class="nav-list-link">2021-04-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210406.html" class="nav-list-link">2021-04-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210407.html" class="nav-list-link">2021-04-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210408.html" class="nav-list-link">2021-04-08</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210409.html" class="nav-list-link">2021-04-09</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210420.html" class="nav-list-link">2021-04-20</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210421.html" class="nav-list-link">2021-04-21</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210422.html" class="nav-list-link">2021-04-22</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210423.html" class="nav-list-link">2021-04-23</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210426.html" class="nav-list-link">2021-04-26</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210427.html" class="nav-list-link">2021-04-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210428.html" class="nav-list-link">2021-04-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210429.html" class="nav-list-link">2021-04-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210503.html" class="nav-list-link">2021-05-03</a></li><li class="nav-list-item active"><a href="/docs/daily-learning-log/20210504.html" class="nav-list-link active">2021-05-04</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210506.html" class="nav-list-link">2021-05-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210507.html" class="nav-list-link">2021-05-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210510.html" class="nav-list-link">2021-05-10</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210511.html" class="nav-list-link">2021-05-11</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210512.html" class="nav-list-link">2021-05-12</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Joeunlog" aria-label="Search Joeunlog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/daily-learning-log/">Daily-learning-log</a></li> <li class="breadcrumb-nav-list-item"><span>2021-05-04</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1> Kubernetes </h1> <h2> Probe </h2> <p>참고 주소</p> <blockquote> <p>https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/</p> </blockquote> <p>컨테이너에서 kubelet에 의해 주기적으로 수행되는 진단</p> <ul> <li>Probe의 종류 <ul> <li>livenessProbe : 컨테이너 동작 여부</li> <li>readinessProbe : 컨테이너 요청 ready 여부</li> <li>startupProbe : 컨테이너 내 App 시작 여부</li> </ul> </li> <li>컨테이너 진단 핸들러 종류 <ul> <li>ExecAction : 컨테이너 내에서 지정 명령어 실행 : 상태코드 0으로 종료 시 진단 성공으로 간주</li> <li>TCPSocketAction : 컨테이너 IP 주소에 대한 TCP 검사 : 특정 Port가 열린 경우 성공으로 간주</li> <li>HTTPGetAction : 컨테이너 IP 주소에 대한 HTTP get 요청 수행 : HTTP 응답 코드가 200~399이면 성공으로 간주</li> </ul> </li> <li>Probe 결과 종류 <ul> <li>Success : 성공</li> <li>Failure : 실패</li> <li>Unknown : 진단 실패 : 액션 수행 x</li> </ul> </li> </ul> <h3> livenessProbe 예시 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># liveness probe 예시 1</span>
apiVersion: v1
kind: Pod
metadata:
  name: liveness-pod
spec:
  containers:
  - name: httpd
    image: httpd
    ports:
    - name: http
      containerPort: 80
      protocol: TCP
    livenessProbe:
      httpGet:
        path: /
        port: 80

<span class="c"># liveness probe 예시 2</span>
apiVersion: v1
kind: Pod
metadata:
  name: liveness3-pod
spec:
  containers:
  - name: db
    image: mysql:5.7
    <span class="nb">env</span>:
    - name: MYSQL_ROOT_PASSWORD
      value: qwer1234
    ports:
    - name: mysql
      containerPort: 3306
      protocol: TCP
    livenessProbe:
      tcpSocket:
        port: 3306

<span class="c"># liveness probe 예시 3</span>
apiVersion: v1
kind: Pod
metadata:
  name: liveness4-pod
spec:
  containers:
  - name: db
    image: mysql:5.7
    <span class="nb">env</span>:
    - name: MYSQL_ROOT_PASSWORD
      value: qwer1234
    ports:
    - name: mysql
      containerPort: 3306
      protocol: TCP
    livenessProbe:
      <span class="nb">exec</span>:
        <span class="nb">command</span>: 
          - <span class="s2">"mysqladmin"</span>
          - <span class="s2">"ping"</span>
          - <span class="s2">"-uroot"</span> 
          - <span class="s2">"-p</span><span class="k">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div> <h3> readinessProbe 예시 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># readiness probe 예시 1</span>
apiVersion: v1
kind: Service
metadata: 
  name: ready-svc
spec:
  selector:
    app: ready
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
<span class="nt">---</span>
apiVersion: apps/v1
kind: ReplicaSet
metadata: 
  name: ready2
  labels:
    app: ready
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ready
  template:
    metadata:
      labels:
        app: ready
    spec:
      containers:
      - name: web
        image: ghcr.io/c1t1d0s7/go-myweb:alpine
        ports:
        - containerPort: 8080
          protocol: TCP
        readinessProbe:
          <span class="nb">exec</span>:
            <span class="nb">command</span>:
            - <span class="s2">"ls"</span>
            - <span class="s2">"/tmp/ready"</span>

<span class="c"># monitoring</span>
watch kubectl get po,svc,ep

kubectl run <span class="nb">test</span> <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--image</span> ghcr.io/c1t1d0s7/network-multitool bash
watch curl http://ready-svc
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> &lt;POD&gt; <span class="nt">--</span> <span class="nb">touch</span> /tmp/ready
kubectl <span class="nb">exec</span> &lt;POD&gt; <span class="nt">--</span> <span class="nb">rm</span> /tmp/ready
</code></pre></div></div> <h3> startupProbe 예시 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: ReplicaSet
metadata: 
  name: start
  labels:
    app: start
spec:
  replicas: 2
  selector:
    matchLabels:
      app: start
  template:
    metadata:
      labels:
        app: start
    spec:
      containers:
      - name: web
        image: ghcr.io/c1t1d0s7/go-myweb:alpine
        ports:
        - containerPort: 8080
          protocol: TCP
        startupProbe:
          httpGet:
            path: /health
            port: 8080
        readinessProbe:
          <span class="nb">exec</span>:
            <span class="nb">command</span>:
            - <span class="s2">"ls"</span>
            - <span class="s2">"/tmp/ready"</span>
<span class="nt">---</span>
apiVersion: v1
kind: Service
metadata: 
  name: start-svc
spec:
  selector:
    app: start
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
</code></pre></div></div> <h2> Deployment </h2> <p>참조 주소</p> <blockquote> <p>https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/</p> </blockquote> <p>pod와 replicaset을 조절 : 선언적 업데이트</p> <p>모든 deployment의 롤아웃 기록은 시스템에 남아있기 때문에 언제든지 롤백 가능</p> <h3> Deployment 예시 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
</code></pre></div></div> <h4> 롤아웃 방법 예시 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply
kubectl edit
kubectl patch
kubectl replace

kubectl <span class="nb">set </span>image deploy nginx-deployment <span class="nv">nginx</span><span class="o">=</span>nginx:1.19
<span class="c"># kubectl set image &lt;리소스종류&gt; &lt;리소스이름&gt; &lt;컨테이너&gt;=&lt;이미지&gt;</span>
</code></pre></div></div> <h4> 히스토리에 코멘트 남기기 </h4> <ul> <li>명령어</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--record</span>
</code></pre></div></div> <ul> <li>annotation</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>metadata:
  annotations:
    kubernetes.io/change-cause: <span class="s2">"XXX"</span>
</code></pre></div></div> <h4> 롤아웃 확인 명령어 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout <span class="nb">history</span> &lt;리소스종류&gt; &lt;리소스이름&gt;
kubectl rollout status &lt;리소스종류&gt; &lt;리소스이름&gt; <span class="nt">-w</span>
</code></pre></div></div> <h4> 롤백 예시 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout undo &lt;리소스종류&gt; &lt;리소스이름&gt; <span class="nt">--to-revision</span><span class="o">=</span>X
</code></pre></div></div> <h3> Six Strategies for Application Deployment </h3> <p>참조 주소</p> <p>https://thenewstack.io/deployment-strategies/</p> <ul> <li>Recreate: Version A is terminated then version B is rolled out.</li> <li>Ramped (also known as rolling-update or incremental): Version B is slowly rolled out and replacing version A.</li> <li>Blue/Green: Version B is released alongside version A, then the traffic is switched to version B.</li> <li>Canary: Version B is released to a subset of users, then proceed to a full rollout.</li> <li>A/B testing: Version B is released to a subset of users under specific condition.</li> <li>Shadow: Version B receives real-world traffic alongside version A and doesn’t impact the response.</li> </ul> <blockquote> <p>kubernetes에는 Recreate와 Ramped만 구현되어 있다.</p> </blockquote> <h2> StatefulSet </h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: myapp-sts
spec:
  selector:
    matchLabels:
      app: myapp
  serviceName: myapp-svc-headless
  replicas: 1
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: ghcr.io/c1t1d0s7/go-myweb
        ports:
        - containerPort: 8080
<span class="nt">---</span>
apiVersion: v1
kind: Service
metadata:
  name: myapp-svc-headless
spec:
  selector:
    app: myapp
  clusterIP: None
  ports:
  - name: http
    port: 80
    targetPort: 8080   
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale sts myapp-sts <span class="nt">--replicas</span><span class="o">=</span>3
</code></pre></div></div> <p>stateful만 상태 저장, 나머지 두 개는 stateless임</p> <p>하나가 죽으면 다시 만들 때 똑같은 이름으로 만든다</p> <p>뭐 하나가 죽으면 다 죽을 때까지 새로운 것을 만들지 않는다</p> <p>svc는 무조건 헤드리스</p> <p>bash명령 쓸 수 있게 나오고 여러 가지 설정을 함</p> <p>pod마다 다른 storage를 가지고 있어서 데이터 불균형 발생</p> <p>애초에 얘는 pod마다 상태를 가지게 하는게 목표인 애라 그게 당연함</p> <p>sharding</p> <p>db 복제 - multi master</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>

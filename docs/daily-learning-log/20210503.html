<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>2021-05-03 - Joeunlog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>2021-05-03 | Joeunlog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="2021-05-03" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <link rel="canonical" href="/docs/daily-learning-log/20210503.html" /> <meta property="og:url" content="/docs/daily-learning-log/20210503.html" /> <meta property="og:site_name" content="Joeunlog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="2021-05-03" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/docs/daily-learning-log/20210503.html","headline":"2021-05-03","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Joeunlog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/" class="nav-list-link">Joeunvit Study log</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/python-study/" class="nav-list-link">Python-study</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/python-study/01-set-environment.html" class="nav-list-link">Setting environment</a></li><li class="nav-list-item "><a href="/docs/python-study/02-data-type.html" class="nav-list-link">Data type</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/daily-learning-log/" class="nav-list-link">Daily-learning-log</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/daily-learning-log/20210127.html" class="nav-list-link">2021-01-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210128.html" class="nav-list-link">2021-01-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210129.html" class="nav-list-link">2021-01-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210201.html" class="nav-list-link">2021-02-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210205.html" class="nav-list-link">2021-02-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210329.html" class="nav-list-link">2021-03-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210330.html" class="nav-list-link">2021-03-30</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210331.html" class="nav-list-link">2021-03-31</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210401.html" class="nav-list-link">2021-04-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210405.html" class="nav-list-link">2021-04-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210406.html" class="nav-list-link">2021-04-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210407.html" class="nav-list-link">2021-04-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210408.html" class="nav-list-link">2021-04-08</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210409.html" class="nav-list-link">2021-04-09</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210420.html" class="nav-list-link">2021-04-20</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210421.html" class="nav-list-link">2021-04-21</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210422.html" class="nav-list-link">2021-04-22</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210423.html" class="nav-list-link">2021-04-23</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210426.html" class="nav-list-link">2021-04-26</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210427.html" class="nav-list-link">2021-04-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210428.html" class="nav-list-link">2021-04-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210429.html" class="nav-list-link">2021-04-29</a></li><li class="nav-list-item active"><a href="/docs/daily-learning-log/20210503.html" class="nav-list-link active">2021-05-03</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210504.html" class="nav-list-link">2021-05-04</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210506.html" class="nav-list-link">2021-05-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210507.html" class="nav-list-link">2021-05-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210510.html" class="nav-list-link">2021-05-10</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210511.html" class="nav-list-link">2021-05-11</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Joeunlog" aria-label="Search Joeunlog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/daily-learning-log/">Daily-learning-log</a></li> <li class="breadcrumb-nav-list-item"><span>2021-05-03</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1> Kubernetes </h1> <h3> 과제 관련 - nfs </h3> <ul> <li>nfs에 server, client가 있고, client에서 server에 접근할 때 계정을 nobody(nogroup에 속한)로 인식한다.</li> <li>즉, client의 root 사용자가 server의 nfs 경로에 접근하더라도 server 입장에서는 nobody라는 사용자가 접근한다고 인식한다.</li> <li>이 때, nfs 설정에서 no_root_squash 옵션을 설정하면 사용자를 nobody로 뭉개서 생각하는 것이 아닌 client에서 접근한 사용자 그대로 인식함</li> <li>nfs 경로 ‘sudo chmod -R 777 /nfs-volume’이 잘 적용됐다면 해당 옵션 없이도 아무나 접근이 가능했을 것</li> </ul> <h2> Dynamic Provisioning </h2> <h3> Rook - Ceph </h3> <p>참고 주소</p> <p>https://ceph.io/</p> <p>https://github.com/rook/rook.git</p> <p>Integrated Storage: 통합 스토리지</p> <ul> <li>Block : RBD(RADOS Block Device)</li> <li>File : CephFS</li> <li>Object : 일반적으로 다른 방법으로 사용하기 때문에 사용x</li> </ul> <p>https://rook.io/docs/rook/v1.6/ceph-quickstart.html</p> <h3> kubespray에 적용 </h3> <p>kubespray vagrantfile 수정</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 추가되는 내용</span>
unless File.exist?<span class="o">(</span><span class="s1">'./.disk/ceph1.vdi'</span><span class="o">)</span>
        vb.customize <span class="o">[</span><span class="s1">'createmedium'</span>, <span class="s1">'disk'</span>, <span class="s1">'--filename'</span>, <span class="s1">'./.disk/ceph1.vdi'</span>, <span class="s1">'--size'</span>, 10240]
      end
      vb.customize <span class="o">[</span><span class="s1">'storageattach'</span>, :id, <span class="s1">'--storagectl'</span>, <span class="s1">'SCSI'</span>, <span class="s1">'--port'</span>, 2, <span class="s1">'--device'</span>, 0, <span class="s1">'--type'</span>, <span class="s1">'hdd'</span>, <span class="s1">'--medium'</span>, <span class="s1">'./.disk/ceph1.vdi'</span><span class="o">]</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># window powershell에서</span>
vagrant reload
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VM에서</span>
ansible <span class="nt">-i</span> ~/kubespray/inventory/mycluster/inventory.ini kube-node <span class="nt">-a</span> <span class="s1">'lsblk -f'</span>

git clone <span class="nt">--single-branch</span> <span class="nt">--branch</span> v1.6.1 https://github.com/rook/rook.git

<span class="c">########## Deploy Operator</span>
<span class="nb">cd </span>rook/cluster/examples/kubernetes/ceph
kubectl create <span class="nt">-f</span> crds.yaml <span class="nt">-f</span> common.yaml <span class="nt">-f</span> operator.yaml

<span class="c"># rook-ceph namespace 생성 확인</span>
kubectl get ns
kubectl get all <span class="nt">-n</span> rook-ceph

<span class="c">########## Create ceph cluster</span>
kubectl create <span class="nt">-f</span> cluster.yaml
<span class="c"># worker node가 하나인 경우에는</span>
<span class="c"># kubectl create -f cluster-test.yaml</span>

<span class="c"># pod 생성 확인 - 시간이 꽤 걸리기 때문에 watch 띄워놓고 대기</span>
watch <span class="nt">-n1</span> <span class="nt">-d</span> kubectl get pod <span class="nt">-n</span> rook-ceph

<span class="c"># 필수 설치 항목 - 해당 항목들 구동 시작 확인 후 다음 단계로</span>
<span class="c"># rook-ceph-crashcollector-k8s-w1</span>
<span class="c"># rook-ceph-crashcollector-k8s-w2</span>
<span class="c"># rook-ceph-crashcollector-k8s-w3</span>
<span class="c"># rook-ceph-mgr-a</span>
<span class="c"># rook-ceph-mon-a</span>
<span class="c"># rook-ceph-mon-b</span>
<span class="c"># rook-ceph-mon-c</span>
<span class="c"># rook-ceph-operator</span>
<span class="c"># rook-ceph-osd-0</span>
<span class="c"># rook-ceph-osd-1</span>
<span class="c"># rook-ceph-osd-2</span>

<span class="c">########## Install toolbox</span>
kubectl create <span class="nt">-f</span> toolbox.yaml

kubectl <span class="nb">exec</span> <span class="nt">-n</span> rook-ceph <span class="nt">-it</span> deployment/rook-ceph-tools <span class="nt">--</span> ceph status

<span class="c"># check !!</span>
<span class="c"># HEALTH_OK : O</span>
<span class="c"># HEALTH_WARN : O</span>
<span class="c"># HEALTH_ERR: X</span>

<span class="c">########## Configure Block Storage</span>

kubectl create <span class="nt">-f</span> csi/rbd/storageclass.yaml

<span class="c">########## Configure File Storage</span>
kubectl create <span class="nt">-f</span> filesystem.yaml

kubectl <span class="nt">-n</span> rook-ceph get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-mds

<span class="c"># check !!</span>
<span class="c"># rook-ceph-mds-myfs-a</span>
<span class="c"># rook-ceph-mds-myfs-b</span>

kubectl create <span class="nt">-f</span> csi/cephfs/storageclass.yaml

<span class="c">## Check Storage Class</span>
kubectl get storageclass

<span class="c"># check !!</span>
<span class="c"># rook-ceph-block</span>
<span class="c"># rook-cephfs</span>
</code></pre></div></div> <p>yaml로 구성할 때</p> <p>provisioner : 일종의 Driver, 정해져있음</p> <p>종류는 아래 참조 주소 참고</p> <p>https://kubernetes.io/ko/docs/concepts/storage/storage-classes/</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get sc
kubectl get sc rook-ceph-block <span class="nt">-o</span> yaml
</code></pre></div></div> <p>sc로 pv를 만들고 동적 프로비저닝</p> <ul> <li>rook-ceph-block <ul> <li>블록 스토리지</li> <li>RWO</li> <li>ROX</li> </ul> </li> <li>rook-cephfs <ul> <li>파일 스토리지</li> <li>RWO</li> <li>RWX</li> <li>ROX</li> </ul> </li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-n</span> rook-ceph <span class="nt">-it</span> deployment/rook-ceph-tools <span class="nt">--</span> ceph <span class="nb">df</span>

<span class="c"># storage가 mirror(일종의 백업)되기 때문에 최대 용량이 10G씩이라고 보면 됨. 이게 기본적으로 8.5G 정도 사용 가능</span>
</code></pre></div></div> <blockquote> <p>레이드가 뭔지 설규환강사님 강의하셨던거 복습해보기</p> </blockquote> <h3> myapp dynamic provisioning </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code myapp-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
spec:
  containers:
    - image: ghcr.io/c1t1d0s7/go-myweb:alpine
      name: myapp
      ports:
        - containerPort: 8080
          name: web
      volumeMounts:
        - name: ceph-vol
          mountPath: /ceph-vol
  volumes:
    - name: ceph-vol
      persistentVolumeClaim:
        claimName: myapp-pvc

code myapp-pvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myapp-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: rook-ceph-block
</code></pre></div></div> <h3> mysql rook-ceph-block db 연동 오류 이유 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">df</span> <span class="nt">-hT</span>
<span class="c"># 파일시스템 종류 확인</span>
kubectl <span class="nb">exec</span> <span class="nt">-it</span> myapp-pod sh
<span class="c"># 정상 구동된 pod에서 연동한 경로 확인해보기</span>
</code></pre></div></div> <p>blockstorage(ex. ext4 file system)을 만들면 자동으로 특정 폴더(lost+found)가 생성됨</p> <p>fsch(file system check) : booting 할 때 자동으로 진행, 수동도 가능</p> <p>/etc/fstab에 booting시 fsch 여부, 순서 나와있음</p> <p>ls -l 에서 권한 다음에 나오는 숫자는 hard link 갯수</p> <p>갑작스런 종료로 인해 hard link가 깨지는 경우가 있음</p> <p>이 때 fsch를 하게 되고, lost+found 폴더에 깨진 파일을 복구시켜줌</p> <p>pvc로 db를 연동시키면 항상 db 초기화를 해야하는데, 해당 폴더에 뭔가가 있으면 구성 초기화를 하지 않는다.</p> <p>mysql pod 생성 때 lost+found 폴더 무시 옵션을 붙여야 함</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>args: <span class="o">[</span><span class="s2">"mysqld"</span>, <span class="s2">"--ignore-db-dir=lost+found"</span><span class="o">]</span>
</code></pre></div></div> <blockquote> <p>참고로, mariadb는 그런 옵션 없이도 잘 됨</p> </blockquote> <h3> mysql dynamic provisioning </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code mysql-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
  labels:
    app: mysql
spec:
  containers:
    - image: mysql:5.7
      name: mysql
      args: ["mysqld", "--ignore-db-dir=lost+found"]
      # ext4 파일 시스템의 lost+found 디렉토리 때문에 초기화 하지 못함
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: qwer1234
      ports:
        - containerPort: 3306
          name: mysql
      volumeMounts:
        - name: db-vol
          mountPath: /var/lib/mysql
  volumes:
    - name: db-vol
      persistentVolumeClaim:
        claimName: mysql-pvc

code mysql-pvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: rook-ceph-block
</code></pre></div></div> <h3> mariadb dynamic provisioning </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code mariadb-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: mariadb-pod
  labels:
    app: mariadb
spec:
  containers:
    - image: mariadb
      name: mariadb
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: qwer1234
      ports:
        - containerPort: 3306
          name: mariadb
      volumeMounts:
        - name: db-vol
          mountPath: /var/lib/mysql
  volumes:
    - name: db-vol
      persistentVolumeClaim:
        claimName: mariadb-pvc

code mariadb-pvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: rook-ceph-block
</code></pre></div></div> <h3> database 구성에 대하여 </h3> <p>block storage 형식의 database는 기본적으로 lock manager이라는 것이 있음</p> <p>동시에 db를 수정할 수 없게 하는 것</p> <p>그래서 RWX를 지원하지 않는다.</p> <p>근데 굳이 file storage 안 쓰고 block storage를 써야하는 이유는 속도 때문</p> <p>block storage가 훨씬 빠르다</p> <p>그래서 Database는 주로 block storage로 구성</p> <p>web 같은 경우는 file storage를 써도 속도 문제가 발생하지 않기 때문에 file storage를 사용</p> <p>file storage의 주 목적은 공유!</p> <p>pvc를 지우지 않는 이상 데이터는 유지됨</p> <p>pod랑 pvc만 올려놨다가 pod를 지우고 다시 생성해도 데이터는 그대로 유지</p> <p>즉, pod와 volume의 life cycle을 분리시키는 것</p> <blockquote> <p>온프레미스에서는 rook을 쓰는게 아닌 이상 동적 프로비저닝이 불가</p> </blockquote> <blockquote> <p>책에서는 rook 안쓰고 AWS에서 실습함 p.428</p> </blockquote> <h3> default storage class </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">########## set default storage class</span>
kubectl edit sc rook-cephfs

metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: <span class="s2">"true"</span>
<span class="c"># annotations(참조) 추가</span>

<span class="c">########## 적용</span>
<span class="c"># pvc에서</span>
storageClassName: <span class="s2">""</span>
<span class="c"># 혹은 아예 지정을 안하면 default storage class를 사용하겠다는 뜻</span>
<span class="c"># 어떤 메뉴얼은 ""이고 어떤 메뉴얼은 지정을 하지 말라고 하는데</span>
<span class="c"># 실습 때에는 지정하지 않은 경우에만 생성이 됐음</span>



</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>

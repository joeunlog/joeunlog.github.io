<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>2021-05-10 - Joeunlog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>2021-05-10 | Joeunlog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="2021-05-10" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <link rel="canonical" href="/docs/daily-learning-log/20210510.html" /> <meta property="og:url" content="/docs/daily-learning-log/20210510.html" /> <meta property="og:site_name" content="Joeunlog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="2021-05-10" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/docs/daily-learning-log/20210510.html","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"2021-05-10","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Joeunlog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/" class="nav-list-link">Joeunvit Study log</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/python-study/" class="nav-list-link">Python-study</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/python-study/01-set-environment.html" class="nav-list-link">Setting environment</a></li><li class="nav-list-item "><a href="/docs/python-study/02-data-type.html" class="nav-list-link">Data type</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/daily-learning-log/" class="nav-list-link">Daily-learning-log</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/daily-learning-log/20210127.html" class="nav-list-link">2021-01-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210128.html" class="nav-list-link">2021-01-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210129.html" class="nav-list-link">2021-01-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210201.html" class="nav-list-link">2021-02-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210205.html" class="nav-list-link">2021-02-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210329.html" class="nav-list-link">2021-03-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210330.html" class="nav-list-link">2021-03-30</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210331.html" class="nav-list-link">2021-03-31</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210401.html" class="nav-list-link">2021-04-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210405.html" class="nav-list-link">2021-04-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210406.html" class="nav-list-link">2021-04-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210407.html" class="nav-list-link">2021-04-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210408.html" class="nav-list-link">2021-04-08</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210409.html" class="nav-list-link">2021-04-09</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210420.html" class="nav-list-link">2021-04-20</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210421.html" class="nav-list-link">2021-04-21</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210422.html" class="nav-list-link">2021-04-22</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210423.html" class="nav-list-link">2021-04-23</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210426.html" class="nav-list-link">2021-04-26</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210427.html" class="nav-list-link">2021-04-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210428.html" class="nav-list-link">2021-04-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210429.html" class="nav-list-link">2021-04-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210503.html" class="nav-list-link">2021-05-03</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210504.html" class="nav-list-link">2021-05-04</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210506.html" class="nav-list-link">2021-05-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210507.html" class="nav-list-link">2021-05-07</a></li><li class="nav-list-item active"><a href="/docs/daily-learning-log/20210510.html" class="nav-list-link active">2021-05-10</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210511.html" class="nav-list-link">2021-05-11</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Joeunlog" aria-label="Search Joeunlog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/daily-learning-log/">Daily-learning-log</a></li> <li class="breadcrumb-nav-list-item"><span>2021-05-10</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1> Kubernetes </h1> <h2> Resource management </h2> <ul> <li>resource <ul> <li>cpu</li> <li>memory</li> <li>huge page</li> </ul> </li> </ul> <h3> metrics-server </h3> <p>단점: 실시간, cpu/memory 메트릭 수집</p> <h4> metrics-server 적용 </h4> <ul> <li>kubespray</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi inventory/mycluster/group_vars/k8s-cluster/addons.yml

metrics_server_enabled: <span class="nb">true

</span>ansible-playbook <span class="nt">-i</span> inventory/mycluster/inventory.ini cluster.yml  <span class="nt">--become</span>
</code></pre></div></div> <ul> <li>minikube</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube addons <span class="nb">enable </span>metrics-server
</code></pre></div></div> <h4> 명령어 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl top nodes
kubectl top pods
kubectl describe node &lt;NODE&gt;
</code></pre></div></div> <h4> resource 정의 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spec:
  containers:
  - resources:
      requests:
        cpu: X
        memory: X
      limits:
        cpu: X
        memory: X
</code></pre></div></div> <ul> <li>limit만 설정하는 경우에는 request가 limit 양 만큼 설정됨</li> </ul> <h4> cpu 부하 테스트 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> &lt;POD&gt; <span class="nt">--</span> <span class="nb">sha1sum</span> /dev/zero
</code></pre></div></div> <h3> LimitRange </h3> <ul> <li>default = 기본 limit</li> <li>defaultRequest = 기본 request</li> <li>default, defaultRequest는 Container type에만 선언</li> <li>max = 할당 최대값</li> <li>min = 할당 최소값 : max와 마찬가지로 설정 가능</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: LimitRange
metadata:
  name: lim1
spec:
  limits:
  - <span class="nb">type</span>: Container
    default:
      cpu: 10m
      memory: 20M
    defaultRequest:
      cpu: 5m
      memory: 10M
  - <span class="nb">type</span>: Pod
    max:
      cpu: 1000m
      memory: 1G
    maxLimitRequestRatio:
      cpu: 2
      memory: 2
  - <span class="nb">type</span>: PersistentVolumeClaim
    min:
      storage: 1Gi
    max:
      storage: 5Gi
</code></pre></div></div> <h3> Resource Quota </h3> <p>오브젝트의 개수 제한</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: ResourceQuota
metadata:
  name: rq
spec:
  hard:
    pods: 10
    services: 5
    services.loadbalancers: 1
    services.nodeports: 2
    configmaps: 5
    secrets: 5
</code></pre></div></div> <h3> Auto Scaling </h3> <ul> <li>기존에는 manual적으로 scaling을 했었음</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale
</code></pre></div></div> <ul> <li>종류 <ul> <li>HPA <ul> <li>Horizontal Pod Autoscaler</li> <li>scale out / in</li> <li>파드의 수를 조정</li> </ul> </li> <li>VPA <ul> <li>Vertical Pod Autoscaler</li> <li>scale up / down</li> <li>파드 요청/제한 조정</li> </ul> </li> <li>CA <ul> <li>Cluster Autoscaler</li> <li>Work Node scale out / in</li> </ul> </li> </ul> </li> </ul> <h4> HPA(Horizontal Pod Autoscaler) </h4> <ul> <li>적용 범위 <ul> <li>ReplicaSet/ReplicationController</li> <li>StatefulSet</li> <li>Deployment</li> </ul> </li> <li>적용 방식 <ul> <li>Pod -&gt; cAdvisor(kubelet) -&gt; Metrics Server -&gt; HPA(scale out? in?)</li> </ul> </li> </ul> <p>kubelet(cAdvisor) ; cAdvisor: Container Advisor</p> <ul> <li>적용시 계산 방식 <ul> <li>원하는 레플리카 수 = ceil[현재 레플리카 수 * ( 현재 메트릭 값 / 원하는 메트릭 값 )]</li> <li>현재 메트릭 값 : current</li> <li>원하는 메트릭 값 : desired</li> </ul> </li> <li>api resource version <ul> <li>autoscaling/v1: CPU 메트릭</li> <li>autoscaling/v2beta2: CPU, Memory, Custom 메트릭</li> </ul> </li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: hpa
spec:
  maxReplicas: 10
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: ReplicaSet
    name: rs1
  targetCPUUtilizationPercentage: 70
</code></pre></div></div> <blockquote> <p>스케일 대상이 되는 컨트롤러는 반드시 request가 설정되어 있어야 함</p> </blockquote> <h4> cool-down timer/delay </h4> <p>scale in/down(축소)는 300s(5분)의 유예기간 후 적용됨</p> <h2> Scheduler </h2> <p>어떤 pod가 어떤 node에서 구동될 지 정하는 것</p> <h3> nodeName </h3> <p>직접 지정 형식</p> <p>.spec.nodename</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># pod 적용 예시</span>
apiVersion: v1
kind: Pod
metadata:
  name: nnpod
spec:
  nodeName: k8s-w3
  containers:
  - name: web
    image: nginx

<span class="c"># ReplicaSet 적용 예시</span>
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nnrs
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nnrs
  template:
    metadata:
      labels:
        app: nnrs
    spec:
      nodeName: k8s-w3
      containers:
      - name: web
        image: nginx    
</code></pre></div></div> <h3> nodeSelector </h3> <p>node의 label로 선택하기</p> <ul> <li>node에 label 붙이기</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl labels node k8s-w2 <span class="nv">gpu</span><span class="o">=</span>titan
kubectl labels node k8s-w3 <span class="nv">gpu</span><span class="o">=</span>titan
<span class="c"># 서로 다른 노드에 같은 label을 붙일 수도 있다 !</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># pod 적용 예시</span>
apiVersion: v1
kind: Pod
metadata:
  name: nspod
spec:
  nodeSelector:
    gpu: titan
  containers:
  - name: web
    image: nginx

<span class="c"># ReplicaSet 적용 예시</span>
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nsrs
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nsrs
  template:
    metadata:
      labels:
        app: nsrs
    spec:
      nodeSelector:
        gpu: titan
      containers:
      - name: web
        image: nginx
</code></pre></div></div> <h3> cordon/drain </h3> <ul> <li>cordon: 해당 노드 스케줄링 금지 <ul> <li>노드 제거</li> <li>노드 유지보수</li> </ul> </li> <li>drain: 현재 실행되고 있는 파드 퇴거(Evict) <ul> <li>drain을 하면 자동 cordon이 됨</li> <li>–ignore-daemonsets</li> <li>–delete-local-data</li> </ul> </li> </ul> <blockquote> <p>drain/cordon을 하고 난 후 해당 node를 다시 스케줄링 가능 상태로 만들려면 반드시 uncordon !</p> </blockquote> <h4> 명령어 </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl cordon
kubectl uncordon
kubectl drain
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>

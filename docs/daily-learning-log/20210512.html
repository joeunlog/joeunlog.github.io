<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>2021-05-12 - Joeunlog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>2021-05-12 | Joeunlog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="2021-05-12" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." /> <link rel="canonical" href="/docs/daily-learning-log/20210512.html" /> <meta property="og:url" content="/docs/daily-learning-log/20210512.html" /> <meta property="og:site_name" content="Joeunlog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="2021-05-12" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/docs/daily-learning-log/20210512.html","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"2021-05-12","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Joeunlog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/docs/" class="nav-list-link">Joeunvit Study log</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/project/" class="nav-list-link">PROJECT</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/project/awseks-semiproject.html" class="nav-list-link">AWS EKS semi project</a></li><li class="nav-list-item "><a href="/docs/project/final-project.html" class="nav-list-link">Final project</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/python-study/" class="nav-list-link">Python</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/python-study/01-set-environment.html" class="nav-list-link">Setting environment</a></li><li class="nav-list-item "><a href="/docs/python-study/02-data-type.html" class="nav-list-link">Data type</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/daily-learning-log/" class="nav-list-link">Daily-learning-log</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/daily-learning-log/20210127.html" class="nav-list-link">2021-01-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210128.html" class="nav-list-link">2021-01-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210129.html" class="nav-list-link">2021-01-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210201.html" class="nav-list-link">2021-02-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210205.html" class="nav-list-link">2021-02-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210329.html" class="nav-list-link">2021-03-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210330.html" class="nav-list-link">2021-03-30</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210331.html" class="nav-list-link">2021-03-31</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210401.html" class="nav-list-link">2021-04-01</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210405.html" class="nav-list-link">2021-04-05</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210406.html" class="nav-list-link">2021-04-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210407.html" class="nav-list-link">2021-04-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210408.html" class="nav-list-link">2021-04-08</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210409.html" class="nav-list-link">2021-04-09</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210420.html" class="nav-list-link">2021-04-20</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210421.html" class="nav-list-link">2021-04-21</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210422.html" class="nav-list-link">2021-04-22</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210423.html" class="nav-list-link">2021-04-23</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210426.html" class="nav-list-link">2021-04-26</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210427.html" class="nav-list-link">2021-04-27</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210428.html" class="nav-list-link">2021-04-28</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210429.html" class="nav-list-link">2021-04-29</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210503.html" class="nav-list-link">2021-05-03</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210504.html" class="nav-list-link">2021-05-04</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210506.html" class="nav-list-link">2021-05-06</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210507.html" class="nav-list-link">2021-05-07</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210510.html" class="nav-list-link">2021-05-10</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210511.html" class="nav-list-link">2021-05-11</a></li><li class="nav-list-item active"><a href="/docs/daily-learning-log/20210512.html" class="nav-list-link active">2021-05-12</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210513.html" class="nav-list-link">2021-05-13</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210514.html" class="nav-list-link">2021-05-14</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210517.html" class="nav-list-link">2021-05-17</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210518.html" class="nav-list-link">2021-05-18</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20210521.html" class="nav-list-link">2021-05-21</a></li><li class="nav-list-item "><a href="/docs/daily-learning-log/20211025.html" class="nav-list-link">2021-10-25</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Joeunlog" aria-label="Search Joeunlog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/daily-learning-log/">Daily-learning-log</a></li> <li class="breadcrumb-nav-list-item"><span>2021-05-12</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1> Kubernetes </h1> <h2> API 접근 </h2> <ul> <li>API server IP 주소 확인하기</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl cluster-info

<span class="c"># 결과</span>
Kubernetes master is running at https://192.168.201.11:6443

To further debug and diagnose cluster problems, use <span class="s1">'kubectl cluster-info dump'</span><span class="nb">.</span>
</code></pre></div></div> <ul> <li>인증서 보기</li> </ul> <p>인증서 위치 : /etc/kubernetes/ssl</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-in</span> ca.crt <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># kubernetes와 kubernetes : root ca이기 때문에 자체서명임</span>

openssl x509 <span class="nt">-in</span> apiserver.crt <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># kubernetes와 kubernetes-apiserver</span>
</code></pre></div></div> <p>인증서를 보면 기한이 있음 : 주기적으로 다음 kube버전으로 업데이트가 필요함(기한 만료되면 멈춤)</p> <p>예를 들면 현재 1.18을 쓰다가 1년이 되기 전에 1.19로 업데이트를 해야 자동으로 인증서도 업데이트가 돼서 문제가 생기지 않음</p> <ul> <li>kubeconfig 파일 내용 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config view
</code></pre></div></div> <ul> <li>config 파일 구조</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Config
preferences: <span class="o">{}</span>

clusters:
- cluster:
    certificate-authority-data: <span class="c"># 인코딩된 데이터</span>
    server: https://192.168.201.11:6443
  name: cluster.local
<span class="nb">users</span>:
- name: kubernetes-admin
  user:
    client-certificate-data: <span class="c"># 인코딩된 데이터</span>
    client-key-data: <span class="c"># 인코딩된 데이터</span>
contexts:
- context:
    cluster: cluster.local
    user: kubernetes-admin
  name: kubernetes-admin@cluster.local

current-context: kubernetes-admin@cluster.local
</code></pre></div></div> <ul> <li>클러스터 목록 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config get-clusters
</code></pre></div></div> <ul> <li>클러스터 생성</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config set-cluster <span class="nb">test</span> <span class="nt">--server</span><span class="o">=</span>https://1.2.3.4:6443
kubectl config set-cluster <span class="nb">test</span> <span class="nt">--certificate-authority</span><span class="o">=</span>/etc/kubernetes/ssl/ca.crt
</code></pre></div></div> <h3> RBAC </h3> <h4> Service Account를 이용한 사용자 인증 구현 </h4> <ol> <li>NS : development</li> <li>SA : devops</li> <li>Role : dev-fc <ul> <li>development NS에 모든 권한</li> </ul> </li> <li>RoleBinding : devops와 dev-fc 연결</li> <li>ClusterRole : cluster-read <ul> <li>cluster 전체 읽기</li> </ul> </li> <li>ClusterRoleBinding : devops와 clust-read 연결</li> <li>kubeconfig(~/.kube/config) : kubectl이 항상 이 config를 참조함 <ul> <li>cluster</li> <li>account</li> <li>context(클러스터-계정)</li> </ul> </li> <li>NS 생성</li> </ol> <p>development라는 이름의 Name Space 생성</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Namespace
metadata:
  name: development
</code></pre></div></div> <ol> <li>SA 생성</li> </ol> <p>devops라는 Service Account 생성</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: devops
  namespace: development
</code></pre></div></div> <ol> <li>Role 생성</li> </ol> <p>dev-fc라는 Role 생성</p> <ul> <li>namespace : development ; role은 특정 ns 한정이기 때문에 지정해줘야 함</li> <li>core ApiGroup</li> <li>all resources</li> <li>all verbs</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dev-fc
  namespace: development
rules:
- apiGroups:
  - <span class="s2">""</span>
  resources:
  - <span class="s2">"*"</span>
  verbs:
  - <span class="s2">"*"</span>
</code></pre></div></div> <ol> <li>RoleBinding</li> </ol> <ul> <li>namespace : development</li> <li>dec-fc(Role)과 devops(Service Account) binding</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: devops-dev-fc
  namespace: development
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dev-fc
subjects:
- apiGroup: <span class="s2">""</span>
  kind: ServiceAccount
  name: devops
  namespace: development
</code></pre></div></div> <ol> <li>ClusterRole</li> </ol> <p>cluster 전체 읽기 권한의 Role : view라는 이름으로 이미 존재하므로 따로 생성할 필요 x</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get clusterRole <span class="c"># 이 명령어로 확인 가능</span>
</code></pre></div></div> <ol> <li>ClusterRoleBinding</li> </ol> <ul> <li>일반 role은 namespace를 지정하지만 cluster role은 전체 cluster에 대한 권한이므로 지정 x</li> <li>devops(Service Account)와 view(Cluster Role) binding</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: devops-view 
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- apiGroup: <span class="s2">""</span>
  kind: ServiceAccount
  name: devops
  namespace: development
</code></pre></div></div> <ol> <li>kubeconfig</li> </ol> <ul> <li>사용자 생성(SA)</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 사용자 생성시 필요한 토큰 정보 확인</span>
kubectl get sa <span class="nt">-n</span> development devops
kubectl describe secrets <span class="nt">-n</span> development devops-token-XXXXX
<span class="c"># 위의 결과값을 아래에서 token에 입력</span>
kubectl config set-credentials devops <span class="nt">--token</span><span class="o">=</span>XXX
</code></pre></div></div> <ul> <li>사용자 생성(사용자;x.509)</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config set-credentials kadmin <span class="nt">--client-certificate</span><span class="o">=</span>&lt;PATH&gt; <span class="nt">--client-key</span><span class="o">=</span>&lt;PATH&gt; <span class="nt">--embed-certs</span>
</code></pre></div></div> <ul> <li>컨텍스트 목록 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config get-contexts
</code></pre></div></div> <ul> <li>현재 컨텍스트</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config current-context
</code></pre></div></div> <ul> <li>컨텍스트 생성</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config set-context devops@test <span class="nt">--cluster</span><span class="o">=</span><span class="nb">test</span> <span class="nt">--user</span><span class="o">=</span>devops <span class="nt">--namespace</span><span class="o">=</span>development
</code></pre></div></div> <ul> <li>컨텍스트 변경 및 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config use-context devops@test
kubectl config get-contexts
kubectl config current-context
</code></pre></div></div> <ul> <li>컨텍스트 이름 변경</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config rename-context &lt;이전이름&gt; &lt;새로운이름&gt;
</code></pre></div></div> <blockquote> <p>이번 실습에서 만들어낸 devops 사용자는 development namespace에서 권한을 apigroup은 ““(core)이고 verbs는 all로 가져서 코어그룹에 한해서 모든 verb를 사용할 수 있다.</p> </blockquote> <blockquote> <p>cluster role은 view로 설정했기 때문에 다른 namespace에 대해서는 read할만한 것들만 가능</p> </blockquote> <p>사용자를 생성하면 secret이 자동 생성되고 거기에 token이 있다.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secret <span class="nt">-n</span> development
<span class="c">#결과</span>
default-token-9k44j   
devops-token-pbtrn    
</code></pre></div></div> <h4> 사용자 계정을 이용한 사용자 인증 구현(with x.509) </h4> <ol> <li>CSR</li> <li>ClusterRole : admin</li> <li>ClusterRoleBinding : kadmin-admin</li> <li>kubeconfig</li> </ol> <ul> <li>일반적인 시나리오 <ul> <li>CA : ca 인증서 / ca 키</li> <li>Client <ol> <li>client key 생성</li> <li>client CSR 생성/요청 (Certificate Signing Request: 인증서 서명 요청) <ul> <li>CA는 client CSR + CA 인증서/키를 이용하여 client 인증서 생성</li> </ul> </li> <li>client 인증서 받음</li> </ol> </li> </ul> </li> <li>x.509 키 생성</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> kadmin.key 2048
</code></pre></div></div> <ul> <li>CSR 생성</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-new</span> <span class="nt">-key</span> kadmin.key <span class="nt">-out</span> kadmin.csr <span class="nt">-subj</span> <span class="s2">"/CN=kadmin"</span>

<span class="c"># base64로 인코딩</span>
<span class="nb">cat </span>kadmin.csr | <span class="nb">base64</span>
</code></pre></div></div> <ul> <li>CSR 리소스 생성</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code csr.yaml

apiVersion: certificates.k8s.io/v1beta1
kind: CertificateSigningRequest
metadata:
  name: kadmin
spec:
  request: |
    <span class="c"># &lt;BASE64로 인코딩 된 값&gt; 들여쓰기 잘하자</span>
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth

kubectl create <span class="nt">-f</span> csr.yaml
<span class="c"># 만약 위의 실습부터 쭉 이어왔다면 실행되지 않을 것 : devops 사용자라서</span>
<span class="c"># kubectl config use-context kubernetes-admin@cluster.local 필요</span>
</code></pre></div></div> <ul> <li>CSR 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get csr
<span class="c"># pending상태일 것 : 승인 필요</span>
</code></pre></div></div> <ul> <li>CSR 승인 : 서명된 인증서 발급</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl certificate approve kadmin
</code></pre></div></div> <ul> <li>CSR 다시 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get csr
<span class="c"># approve, issued 상태가 됨</span>
</code></pre></div></div> <ul> <li>CSR 인증서 발행</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get csr kadmin <span class="nt">-o</span> yaml
<span class="c"># csr.status.certificate 항목에 있는 게 인증서임!</span>
kubectl get csr kadmin <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.certificate}'</span>
<span class="c"># 인증서 내용만 빠르게 보는 방법</span>
kubectl get csr kadmin <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.certificate}'</span> | <span class="nb">base64</span> <span class="nt">-d</span>
<span class="c"># 인증서 내용 디코딩해서 보는 방법</span>
kubectl get csr kadmin <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.certificate}'</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> kadmin.crt
<span class="c"># 인증서 디코딩한 내용 kadmin.crt 파일에 저장하기</span>
</code></pre></div></div> <h3> 원격 클라이언트 적용 방법 </h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 윈도우 파워쉘 관리자권한</span>
choco <span class="nb">install </span>kubernetes-cli <span class="nt">--version</span><span class="o">=</span>1.19.5 <span class="o">[</span><span class="nt">--allowdowngrade</span><span class="o">]</span>
<span class="c"># kubernetes-cli가 이미 설치된 게 아니면 [--allowdowngrade] 생략 가능</span>
kubectl version
<span class="c"># 버전 확인</span>

<span class="c"># VM에서</span>
<span class="nb">cp</span> ~/.kube/config /vagrant

<span class="c"># 윈도우 환경에서</span>

c:<span class="se">\U</span>sers<span class="se">\j</span>eunv<span class="se">\v</span>agrant<span class="se">\k</span>8s<span class="se">\c</span>onfig <span class="nt">----copy---</span><span class="o">&gt;</span> c:<span class="se">\U</span>sers<span class="se">\j</span>eunv<span class="se">\.</span>kube<span class="se">\c</span>onfig
</code></pre></div></div> <blockquote> <p>window에서 연결해서 쓰면 결국 powershell을 쓰는 것이기 때문에 자동완성 기능이 없음</p> </blockquote> <p>vm을 사용하지 않고 window 환경에서 쿠버네티스를 돌린다?</p> <p>git bash나 window에서 지원하는 linux쉘을 다운로드해서 사용함</p> <p>하이퍼v를 사용하기 때문에 현재 실습 환경에는 맞지 않음</p> <h2> Helm </h2> <p>kubectl이 설치되어 있고 config파일이 있는 환경에서 쓸 수 있는 패키지 매니저</p> <h3> Helm 설치 </h3> <p>snap이라는 패키지 관리자는 거의 모든 linux 환경에서 쓰는 건데 안정적이지 않아서 사용하지 않을 것</p> <p>script를 이용하여 설치</p> <p>참고주소</p> <blockquote> <p>https://helm.sh/ko/docs/intro/install/</p> </blockquote> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-fsSL</span> <span class="nt">-o</span> get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
<span class="nb">chmod</span> +x get_helm.sh
./get_helm.sh
helm version
<span class="c"># 우리는 helm3 사용</span>
</code></pre></div></div> <ul> <li>completion (자동완성)</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm completion bash | <span class="nb">sudo tee</span> /etc/bash_completion.d/helm
<span class="nb">exec </span>bash
</code></pre></div></div> <h3> Helm 개요 </h3> <ul> <li>차트 : 헬름 패키지</li> <li>저장소 : 차트를 모아두고 공유하는 장소</li> <li> <p>릴리스 : 쿠버네티스 클러스터에서 구동되는 차트의 인스턴스 혹은 설치된 차트</p> </li> <li>찾기</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm search hub wordpress
<span class="c"># hub에서 wordpress를 찾는다는 의미</span>
helm search hub mysql
</code></pre></div></div> <ul> <li>repo 추가</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add stable https://charts.helm.sh/stable
<span class="c"># 안정적인걸 관습적으로 stable이라고 하는데 꼭 stable일 필요는 없다</span>
</code></pre></div></div> <ul> <li>repo 삭제</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo remove stable
</code></pre></div></div> <ul> <li>repo 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo list
</code></pre></div></div> <ul> <li>repo에서 찾기</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm search repo mysql
<span class="c"># 결과에서 stable/로 시작하는 것들은 내가 repo를 stable로 지정했기 때문</span>
</code></pre></div></div> <blockquote> <p>주로 다 deprecated 되어있음 : 가능하면 artifact hub를 써라!</p> </blockquote> <ul> <li>차트 설치 = 릴리즈 만들기 : value 변경 없이</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install</span> &lt;설정할 릴리즈이름&gt; &lt;repo이름&gt;/&lt;차트이름&gt;

helm <span class="nb">install </span>happy-panda stable/mariadb
</code></pre></div></div> <ul> <li>차트 설치 = 릴리즈 만들기 : value 변경 : customize</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi values.yaml <span class="c"># 이름 이무거나 상관 없음</span>
<span class="c"># 덮어쓰고자 하는 내용만 차트의 values.yaml 참고해서 똑같이 작성</span>
service:
  <span class="nb">type</span>: LoadBalancer

helm <span class="nb">install </span>happy-panda stable/mariadb <span class="nt">-f</span> values.yaml
</code></pre></div></div> <blockquote> <p>value가 적용되는 부분에서 많은 문제가 발생할 수 있음 : 이 경우 아예 실행이 잘 안 될 수도 있음 그런 문제가 생길 경우 upgrade나 rollback에 문제가 생길 수 있으며 이런 경우에는 수동으로 수정을 해야함</p> </blockquote> <ul> <li>릴리즈 삭제</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm uninstall &lt;릴리즈이름&gt;
helm uninstall happy-panda
</code></pre></div></div> <blockquote> <p>helm2랑 helm3랑 구조적으로 달라서 명령어도 차이가 나기 때문에 자료를 찾아서 사용할 때에는 그게 2인지 3인지 잘 보고 써야함 helm 2는 문제가 많으므로 3을 권장함</p> </blockquote> <ul> <li>설치된 릴리즈 목록 확인</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm list
</code></pre></div></div> <ul> <li>가동 resource 확인 : 릴리즈가 설치되면 거기에 포함된 resource들이 자동으로 구동됨</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get all
kubectl get configmap
kubectl get secret
helm status happy-panda
</code></pre></div></div> <ul> <li>helm show <ul> <li>all : chart + readme + values</li> <li>chart : 차트 정보(패키지 정보) ex. 버전, etc : 차트가 저장되어 있는 곳(repo)의 해당 차드의 Chart.yaml</li> <li>readme : README.md</li> <li>values : 사용자가 설정할 수 있는 값들</li> </ul> </li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm show all stable/mysql
helm show chart stable/mysql
helm show readme stable/mysql
helm show values stable/mysql
</code></pre></div></div> <ul> <li>차트 구조 <ul> <li>Chart.yaml</li> <li>README.md</li> <li>values.yaml</li> <li>/templates</li> </ul> </li> <li>helm upgrade</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">-f</span> &lt;덮어쓸value yaml파일&gt; &lt;릴리즈이름&gt; &lt;repo&gt;/&lt;차트&gt;
helm upgrade <span class="nt">-f</span> value.yaml happy-panda stable/mariadb
<span class="c"># Revision이 2로 바뀜 : upgrade 할 때마다 올라가는 듯</span>
</code></pre></div></div> <ul> <li>helm history</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">history </span>happy-panda
</code></pre></div></div> <ul> <li>helm rollback</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm rollback &lt;릴리즈이름&gt; &lt;revision번호&gt;
helm rollback happy-panda 1
</code></pre></div></div> <ul> <li>차트 만들기</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm create &lt;차트이름&gt;
helm create abc
<span class="c"># 차트이름과 같은 폴더가 생기고 그 안에는 reference가 자동 생성됨</span>
</code></pre></div></div> <ul> <li>차트 패키징</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm package &lt;차트이름&gt;
helm package abc
<span class="c"># abc-0.1.0.tgz 파일이 생성됨 : 이 파일을 repo에 올리면 됨</span>
</code></pre></div></div> <ul> <li>local에 있는 차트 설치</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install</span> &lt;새릴리즈이름&gt; &lt;tgz파일위치&gt;
helm <span class="nb">install </span>newabc ./abc-0.1.0.tgz
</code></pre></div></div> <blockquote> <p>kubectl 명령어 칠 때, 자동완성 편하게 하려면 kubectl -n <namespace> <verb> <항목> 형식이 좋음</항목></verb></namespace></p> </blockquote> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
